<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/codemirror/5.5.0/codemirror.min.css">
<script src="//cdnjs.cloudflare.com/ajax/libs/codemirror/5.5.0/codemirror.min.js" type="text/javascript"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/codemirror/5.5.0/mode/xml/xml.min.js" type="text/javascript"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/codemirror/5.5.0/mode/css/css.min.js" type="text/javascript"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/codemirror/5.5.0/mode/javascript/javascript.min.js" type="text/javascript"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/codemirror/5.5.0/mode/htmlmixed/htmlmixed.min.js" type="text/javascript"></script>

<h1>Page Editor</h1>

<page-editor></page-editor>

<!-- Page Editor -->
<template for="page-editor">
    <div class="buttons">
        <button class="btn btn-danger" id="cancel">
            <icon>remove</icon>
            <span>Cancel</span>
        </button>

        <button class="btn btn-info editPreviewToggle" id="preview">
            <icon>eye-open</icon>
            <span>Preview</span>
        </button>

        <button class="btn btn-info hidden editPreviewToggle" id="edit">
            <icon>pencil</icon>
            <span>Edit</span>
        </button>

        <button class="btn btn-warning" id="save">
            <icon>save</icon>
            <span>Save</span>
        </button>
    </div>

    <code-mirror data-source-url="/api/content/read/{{contentPath}}"></code-mirror>

    <preview></preview>
</template>

<style for="page-editor">
    code-mirror {
        display: block;
        border: 1px solid #eee;
        border-radius: 3px;
    }

    page-editor > div.buttons {
        border: 1px solid #eee;
        border-radius: 3px;
        padding: 5px;
        text-align: right;
        margin-bottom: 3px;
    }

    page-editor > div.buttons > button {
      width: 90px;
    }
</style>

<script type="text/javascript">
    $(function() {
        var PageEditorComponent = Component.configure('page-editor');

        var contentPath = decodeURIComponent(getUrlParameter('page'));

        PageEditorComponent.on('preRenderStep', function(instance) {
            instance.contentPath = contentPath;
        });

        PageEditorComponent.on('renderComplete', function(instance) {
            var previewBox = $('preview', instance.element);
            var codeMirror = $('code-mirror', instance.element);

            $('button#cancel').click(function() {
                // TODO: Check for unsaved changes and warn the user
                window.location = '/content/' + instance.contentPath;
            });

            $('button#edit').click(function() {
                codeMirror.show();
                previewBox.html('').hide();
                showPreviewButton();
            });

            $('button#preview').click(function() {
                showEditButton();
                codeMirror.hide();
                previewBox.html('Trying to access code mirror content...').show();
            });

            $('button#save').click(function() {
                // TODO: Save changes and redirect to page
                alert('Save not implemented yet.');
            });

            function showPreviewButton() {
                $('button#preview').removeClass('hidden');
                $('button#edit').addClass('hidden');
            }

            function showEditButton() {
                $('button#edit').removeClass('hidden');
                $('button#preview').addClass('hidden');
            }
        });

        PageEditorComponent.apply(function(instance) {
            instance.render();
        });

        function getUrlParameter(sParam) {
            var sPageURL = window.location.search.substring(1);
            var sURLVariables = sPageURL.split('&');
            for (var i = 0; i < sURLVariables.length; i++) {
                var sParameterName = sURLVariables[i].split('=');
                if (sParameterName[0] == sParam) {
                    return sParameterName[1];
                }
            }
        }
    });
</script>

<!-- Code Mirror -->
<template for="code-mirror">
    <!-- Content for {{path}} loaded from {{dataSourceUrl}} -->
    <!--{{{body}}}-->
</template>

<script type="text/javascript">
    $(function() {
        var CodeMirrorComponent = Component.configure('code-mirror');

        CodeMirrorComponent.on('renderComplete', function(instance) {
            var contents = instance.body;
            var mode = instance.mode || "htmlmixed";

            if (instance.body) {
                instance.codeMirror = CodeMirror(instance.element, {
                    value: contents,
                    lineNumbers: true,
                    mode: mode,
                    viewportMargin: Infinity
                });
            }
        });
    });
</script>

<style for="code-mirror">
    code-mirror .CodeMirror {
        height: auto;
    }
</style>
